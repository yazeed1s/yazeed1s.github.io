<!doctype html>
<html lang="en">

<head>
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<meta name="description" content="What brokers actually give you when they say exactly-once." />
<meta
    name="keywords"
    content="yazeed, blog, alharthi, yaz, yazeed1s"
/>
<link rel="canonical" href="https://yazeed1s.github.io/posts/exactly-once/" />

<title>Exactly-Once Is a Lie | Yazeed&#x27;s Blog</title>
<meta property="og:site_name" content="Yazeed&#x27;s Blog" />
<meta property="og:title" content="Exactly-Once Is a Lie | Yazeed&#x27;s Blog" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://yazeed1s.github.io/posts/exactly-once/" />
<meta property="og:description" content="What brokers actually give you when they say exactly-once." />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:title" content="Exactly-Once Is a Lie" />
<meta name="twitter:description" content="What brokers actually give you when they say exactly-once." />

    <link rel="icon" href="&#x2F;favicon.ico" />
    
    <link rel="stylesheet" href="https://yazeed1s.github.io/font.css" />
    <link rel="stylesheet" href="https://yazeed1s.github.io/css/base.css" />

           
    
    
    

          
    
    
    
    <style>
        :root {
            --nav-basis: 25%;
            --light-bg: #eae6deff;
            --light-text: #1a1410;
            --light-text-muted: #1a1410;
            --light-accent: #9E4440;
            --light-accent-hover: #7A3533;
            --light-code-bg: #e1ded6ff;
            --light-border: #abaaaaff;
            --light-bold: #1a1410;
            --light-italic: #1a1410;
            --light-headers: #1a1410;
            --dark-bg: #303132;
            --dark-text: #bebbb9ff;
            --dark-text-muted: #d5d2cf;
            --dark-accent: #e57665;
            --dark-accent-hover: #888885;
            --dark-code-bg: #282829;
            --dark-border: #524f4c;
            --dark-bold: #d5d2cf;
            --dark-italic: #d5d2cf;
            --dark-headers: #d5d2cf;
        }
    </style>
    <meta name="theme-color" id="tc" />
    <script>
        (function () {
            var m = matchMedia("(prefers-color-scheme:dark)"),
                t = localStorage.theme || (m.matches ? "dark" : "light"),
                h = document.documentElement,
                c = document.getElementById("tc");
            h.className = t;
            function u() {
                c.content = getComputedStyle(h).getPropertyValue("--tc");
            }
            u();
            window.T = function () {
                t = t === "dark" ? "light" : "dark";
                localStorage.theme = t;
                h.className = t;
                u();
            };
        })();
    </script>
    
</head>

<body>
    <a href="#main" class="skip-link">Skip to content</a>
    <svg xmlns="http://www.w3.org/2000/svg" style="display:none"><symbol id="light" viewBox="0 0 32 32"><rect x="15" y="2" width="2" height="5"/><rect x="21.6675" y="6.8536" width="4.958" height="1.9998" transform="translate(1.5191 19.3744) rotate(-45)"/><rect x="25" y="15" width="5" height="2"/><rect x="23.1466" y="21.6675" width="1.9998" height="4.958" transform="translate(-10.0018 24.1465) rotate(-45)"/><rect x="15" y="25" width="2" height="5"/><rect x="5.3745" y="23.1466" width="4.958" height="1.9998" transform="translate(-14.7739 12.6256) rotate(-45)"/><rect x="2" y="15" width="5" height="2"/><rect x="6.8536" y="5.3745" width="1.9998" height="4.958" transform="translate(-3.253 7.8535) rotate(-45)"/><path d="M16,12a4,4,0,1,1-4,4,4.0045,4.0045,0,0,1,4-4m0-2a6,6,0,1,0,6,6,6,6,0,0,0-6-6Z"/></symbol>
<symbol id="asleep" viewBox="0 0 32 32"><path d="M13.5025,5.4136A15.0755,15.0755,0,0,0,25.096,23.6082a11.1134,11.1134,0,0,1-7.9749,3.3893c-.1385,0-.2782.0051-.4178,0A11.0944,11.0944,0,0,1,13.5025,5.4136M14.98,3a1.0024,1.0024,0,0,0-.1746.0156A13.0959,13.0959,0,0,0,16.63,28.9973c.1641.006.3282,0,.4909,0a13.0724,13.0724,0,0,0,10.702-5.5556,1.0094,1.0094,0,0,0-.7833-1.5644A13.08,13.08,0,0,1,15.8892,4.38,1.0149,1.0149,0,0,0,14.98,3Z"/></symbol>
<symbol id="rss" viewBox="0 0 32 32"><path d="M8,18c-3.3,0-6,2.7-6,6s2.7,6,6,6s6-2.7,6-6C14,20.7,11.3,18,8,18z M8,28c-2.2,0-4-1.8-4-4s1.8-4,4-4s4,1.8,4,4C12,26.2,10.2,28,8,28z"/><path d="M30,24h-2C28,13,19,4,8,4V2C20.1,2,30,11.9,30,24z"/><path d="M22,24h-2c0-6.6-5.4-12-12-12v-2C15.7,10,22,16.3,22,24z"/></symbol>
</svg>

    <header id="site-header">
        <div>
            <span class="header-brand"><a href="https://yazeed1s.github.io"><strong><span style="color: var(--accent-hover);">~/</span>Yazeed&#x27;s Blog</strong></a></span>
            <nav>
                <a href="https://yazeed1s.github.io/" >Home</a>
                <a href="https://yazeed1s.github.io/posts/"  class="active" >Posts</a>
                <a href="https://yazeed1s.github.io/projects/" >Projects</a>
                <a href="https://yazeed1s.github.io/tags/" >Tags</a>
                </nav>
            <a href="#" onclick="
                        T();
                        return false;
                    " class="theme" aria-label="Toggle theme" title="Toggle theme">
<svg><use href="#light"/></svg>
<svg><use href="#asleep"/></svg></a>
        </div>
    </header>
    <hr class="site-sep" />
    <main id="main">
<article>
    <header>
        <h1>Exactly-Once Is a Lie</h1>
        <div class="post-meta">
            <time datetime="2025-08-04">04 Aug 2025</time>
            
            <span>What brokers actually give you when they say exactly-once.</span>
             
            <span class="post-tags">
                <span class="post-tags-label">Tags: </span>
                
                <a href="https://yazeed1s.github.io/tags/distributed-systems">Distributed Systems</a><span
                    class="tag-comma">,</span> 
                <a href="https://yazeed1s.github.io/tags/event-driven">Event Driven</a><span
                    class="tag-comma">,</span> 
                <a href="https://yazeed1s.github.io/tags/messaging">Messaging</a>
            </span>
            
        </div>
    </header>
     <p>Every message broker eventually puts "exactly-once" somewhere in its docs. Kafka has it. Pulsar claims it. NATS JetStream has a version of it. It sounds like the thing you want. Send a message, it arrives once, nobody worries.</p>
<p>But exactly-once delivery doesn't exist. What exists is engineering around the fact that it doesn't.</p>
<h2 id="what-can-actually-happen">what can actually happen</h2>
<p>A producer sends a message to a broker. Three outcomes:</p>
<ol>
<li>Broker receives it, acknowledges, producer gets the ack. Success.</li>
<li>Broker receives it, acknowledges, but the ack is lost. Producer doesn't know it worked. It retries. Now there are two copies.</li>
<li>Broker never receives it. Message is gone.</li>
</ol>
<p>That's it. Those are the options on an unreliable network. You can avoid case 3 by retrying. But retrying introduces case 2. You cannot eliminate both.</p>
<p>This is the fundamental issue. At the network level, you get at-most-once (don't retry, accept losses) or at-least-once (retry, accept duplicates). There's no third option that the network gives you for free.</p>
<h2 id="what-kafka-actually-does">what Kafka actually does</h2>
<p>Kafka advertises exactly-once semantics. What it actually implements is two things working together.</p>
<p><strong>Idempotent producer.</strong> Each producer gets an ID. Each message gets a sequence number. If the broker sees the same producer ID + sequence number twice, it drops the duplicate. This handles the lost-ack problem. The producer retries, the broker deduplicates.</p>
<p>This only works within a single producer session. If the producer crashes and restarts with a new ID, the deduplication state is gone.</p>
<p><strong>Transactions.</strong> Kafka lets you wrap a consume-process-produce cycle in a transaction. Read from input topic, do work, write to output topic, commit offsets. All atomically. If anything fails, everything rolls back.</p>
<p>So Kafka doesn't deliver messages exactly once. It uses at-least-once delivery with deduplication and atomic commits to make the <em>processing</em> behave as if messages were delivered once. The duplicates still happen at the transport layer. The broker just hides them.</p>
<h2 id="delivery-vs-processing">delivery vs processing</h2>
<p>This distinction matters.</p>
<p><strong>Exactly-once delivery</strong> would mean the network guarantees each message arrives once. No system does this. The network is unreliable. Acks get lost. Connections drop. Machines crash between receiving and acknowledging.</p>
<p><strong>Exactly-once processing</strong> means the side effects of handling a message happen once, even if the message itself arrives more than once. That's achievable. But it requires work. Deduplication, idempotency, transactions. It's not a delivery guarantee, it's an application-level property.</p>
<p>When brokers say "exactly-once" they mean the second thing. They don't say that clearly.</p>
<h2 id="the-broker-can-t-save-you-everywhere">the broker can't save you everywhere</h2>
<p>Even with Kafka transactions, exactly-once only works within Kafka. Read from Kafka, write to Kafka, commit. That's a closed system. Kafka controls both sides.</p>
<p>The moment your consumer does something outside Kafka, the guarantee breaks. Write to a database? Send an HTTP request? Call an external API? Kafka doesn't know about those. If your consumer processes a message, writes to Postgres, then crashes before committing the Kafka offset, it'll reprocess on restart. Postgres gets the write twice.</p>
<p>This is where the inbox pattern from my <a href="https://yazeed1s.github.io/posts/outbox-inbox-patterns/">outbox/inbox post</a> comes in. You need idempotency at your handler level. Record that you processed this message before doing the work. If you see it again, skip it.</p>
<p>The broker gives you tools. It doesn't give you a complete solution.</p>
<h2 id="idempotency-is-always-your-problem">idempotency is always your problem</h2>
<p>Regardless of what your broker promises, if your consumer has side effects, you need to handle duplicates. Either:</p>
<ul>
<li>Make the operation naturally idempotent (SET is idempotent, INCREMENT is not)</li>
<li>Track processed message IDs and skip duplicates</li>
<li>Use transactions that span both the broker offset and your external state (hard, often impractical)</li>
</ul>
<p>At-least-once delivery + idempotent handling gives you the effect of exactly-once. That's what production systems actually do. The "exactly-once" label is marketing over a real but narrower mechanism.</p>
<h2 id="notes">notes</h2>
<ul>
<li>Two Generals Problem: you can't get agreement over an unreliable channel with finite messages. This is why ack-loss is unavoidable.</li>
<li>Kafka's exactly-once (KIP-98) was controversial when introduced. The original blog post title was literally "Exactly-once Semantics are Possible" which tells you something.</li>
<li>NATS JetStream does deduplication by message ID with a configurable window. Similar idea, simpler scope.</li>
<li>Pulsar transactions work similarly to Kafka. Read-process-write atomically within Pulsar.</li>
<li>If you're using a broker without deduplication, you're getting at-least-once at best. Plan for it.</li>
<li>"Effectively exactly-once" is the more honest term some people use. I prefer it.</li>
</ul>
  
</article>
</main>
    <hr class="site-sep bottom-sep" />
    <footer class="s">
        
    </footer>
    

    <script>
        document.querySelectorAll("article img[srcset]").forEach((i) => {
            if (i.closest("a")) return;
            i.style.cursor = "pointer";
            i.onclick = () => {
                let d = document.createElement("div"),
                    s = i.srcset.split(",").pop().trim().split(" ")[0];
                d.className = "lb";
                d.innerHTML = '<img src="' + s + '">';
                document.body.style.overflow = "hidden";
                d.onclick = () => {
                    d.remove();
                    document.body.style.overflow = "";
                };
                document.body.appendChild(d);
            };
        });
    </script>
    
<button id="scroll-to-top" aria-label="Scroll to top" title="Scroll to top">â†‘</button>
<script>
    (function() {
        var btn = document.getElementById("scroll-to-top");
        if (btn) {
            window.addEventListener("scroll", function() {
                if (document.body.scrollTop > 300 || document.documentElement.scrollTop > 300) {
                    btn.classList.add("show");
                } else {
                    btn.classList.remove("show");
                }
            });
            btn.addEventListener("click", function() {
                window.scrollTo({top: 0, behavior: 'smooth'});
            });
        }
    })();
</script>
</body>

</html>